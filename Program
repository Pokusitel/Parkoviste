#include <MQ135.h>
#include <Servo.h> 
#include <Wire.h> 
#include <LiquidCrystal_I2C.h>
LiquidCrystal_I2C lcd(0x27, 20, 4);

Servo myservo;

#define ir_enter 2
#define ir_back  4

#define ir_car1 5
#define ir_car2 6
#define ir_car3 7
#define ir_car4 8
#define ir_car5 9
#define ir_car6 10

#define pinA A0
#define pinD 11

MQ135 senzorMQ = MQ135(pinA);

int P1=0, P2=0, P3=0, P4=0, P5=0, P6=0;
int flag1=0, flag2=0; 
int slot = 6;  

int stav = pinD;
int buttonPinE = 11;      // připojení tlačítka 
int buttonStateE = 0;    // proměnná pro ukládání stavu tlačítka
int buttonPinN = 12;      
int buttonStateN = 0;    

void setup(){
  pinMode(pinD, INPUT); // senzor plynu, pin na sepnutí při nebezpečí
  pinMode(12, OUTPUT); // nastavení, že je jako vstup
  // inicializace LCD
  lcd.begin();
  // zapnutí podsvícení
  lcd.backlight();
 Serial.begin(9600);

 pinMode(ir_car1, INPUT); //inicializace vstupu ze senzorů
 pinMode(ir_car2, INPUT);
 pinMode(ir_car3, INPUT);
 pinMode(ir_car4, INPUT);
 pinMode(ir_car5, INPUT);
 pinMode(ir_car6, INPUT);

 pinMode(ir_enter, INPUT);
 pinMode(ir_back, INPUT);

 pinMode(buttonPinE, INPUT);
 pinMode(buttonPinN, INPUT);
  
 myservo.attach(3);
 myservo.write(90);

 //lcd.begin(20, 4);  
 lcd.setCursor (0,1);
 lcd.print("      Parkovaci  ");
 lcd.setCursor (0,2);
 lcd.print("       System     ");
 delay (2000);
 lcd.clear();   

 Read_Sensor();

 int total = P1+P2+P3+P4+P5+P6;
 slot = slot-total;
 slot <= 6; // 

 //attachInterrupt(digitalPinToInterrupt(pinD), prerus, RISING);
}

void loop(){
  // načtení koncentrace plynů v ppm do proměnné
  //float ppm = senzorMQ.getPPM();
 if(stav = HIGH) { // pokud je stav nebezpečí a přišel signál ze senzoru MQ135, tak se napíše upozornění a sepne relé
    lcd.setCursor(0, 0);
   lcd.print("                    ");
    lcd.setCursor (0,0);
   lcd.print("  NEBEZPECI OTRAVA  "); 
   digitalWrite(12, HIGH);
 }
 else { //není stav nebezpečí, žádná změna
    lcd.setCursor(0, 0);
   lcd.print("                    ");
   digitalWrite(12, LOW);
   lcd.setCursor (0,0);
   lcd.print("   Volna mista: "); 
 }

 Read_Sensor();

 buttonStateE = digitalRead(buttonPinE); // čtení stavu tlačítka
 buttonStateN = digitalRead(buttonPinN); // čtení stavu tlačítka


 lcd.setCursor (0,0);
 lcd.print("   Volna mista: "); 
 lcd.print(slot);
 lcd.print("    ");  

 if (buttonStateE == HIGH) { // pokud je tlačítko stisknuto PRVNÍ
    do {
      // Akce pro P1
      lcd.setCursor(0, 0);
      if (P1 == 1) {
        lcd.print("P1: Plny ");
        break;
      } else {
        lcd.print("P1: Volny");
        Serial.println("1"); // odeslat 1 do druhého Arduina
      }

      // Akce pro P2
      lcd.setCursor(10, 1);
      if (P2 == 1) {
        lcd.print("P2: Plny ");
        break;
      } else {
        lcd.print("P2: Volny");
        Serial.println("2");
      }

      // Akce pro P3
      lcd.setCursor(0, 2);
      if (P3 == 1) {
        lcd.print("P3: Plny ");
        break;
      } else {
        lcd.print("P3: Volny");
        Serial.println("3");
      }

      // Aktualizace stavů P1, P2 a P3
      P1 = digitalRead(ir_car1);
      P2 = digitalRead(ir_car2);
      P3 = digitalRead(ir_car3);
    } while (true);
  }

 if (buttonStateN == HIGH) { // pokud je tlačítko stisknuto DRUHÉ
    do {
      // Akce pro P4
      lcd.setCursor(10, 0);
      if (P4 == 1) {
        lcd.print("P4: Plny ");
        break;
      } else {
        lcd.print("P4: Volny");
        Serial.println("4");
      }

      // Akce pro P5
      lcd.setCursor(0, 1);
      if (P5 == 1) {
        lcd.print("P5: Plny ");
        break;
      } else {
        lcd.print("P5: Volny");
        Serial.println("5");
      }

      // Akce pro P6
      lcd.setCursor(10, 2);
      if (P6 == 1) {
        lcd.print("P6: Plny ");
        break;
      } else {
        lcd.print("P6: Volny");
        Serial.println("6");
      }
      P4 = digitalRead(ir_car4);
      P5 = digitalRead(ir_car5);
      P6 = digitalRead(ir_car6);
    } while (true);
  }


 if(digitalRead (ir_enter) == 0 && flag1==0){
   if(slot>0){flag1=1;
   if(flag2==0){myservo.write(180); slot = slot-1;}
     }
   else{
     lcd.setCursor (0,0);
     lcd.print(" Mas smulu, PLNO ");  
     delay(1500);
    }   
  }

 if(digitalRead (ir_back) == 0 && flag2==0){flag2=1;
 if(flag1==0){myservo.write(180); slot = slot+1;}
  }

 if(flag1==1 && flag2==1){
   delay (1000);
   myservo.write(90);
   flag1=0, flag2=0;
  }

 delay(300);
}

void Read_Sensor(){
P1=0, P2=0, P3=0, P4=0, P5=0, P6=0;

if(digitalRead(ir_car1) == 0){P1=1;}
if(digitalRead(ir_car2) == 0){P2=1;}
if(digitalRead(ir_car3) == 0){P3=1;}
if(digitalRead(ir_car4) == 0){P4=1;}
if(digitalRead(ir_car5) == 0){P5=1;}
if(digitalRead(ir_car6) == 0){P6=1;}  
}
